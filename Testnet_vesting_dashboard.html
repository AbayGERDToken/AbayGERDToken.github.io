<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GERD Token Vesting Dashboard - Testnet</title>
  
  <!-- Bootstrap 5.3.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/main.css"/>
  
  <!-- Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
</head>
<body>
  <!-- Dynamic Navbar -->
  <div id="navbar-container"></div>
  <script>
    fetch('navtest.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('navbar-container').innerHTML = html;
      })
      .catch(err => console.error('Error loading navbar:', err));
  </script>

  <div class="container my-5">
    <div class="card bg-success-subtle shadow-lg">
      <div class="card-body p-5">
        <h1 class="h2 text-center text-success mb-4"><i class="fas fa-chart-line me-2"></i>Vesting Release Dashboard on Testnet</h1>
        <div class="alert alert-info border-start border-4 border-info">
          <p class="mb-0 small">This dashboard is for community members to follow the progress of the GERD Token Vesting contract testing on the BSC Testnet. To simulate a long-term token release (1 billion GERD tokens per year for 115 years), the vesting contract on testnet is configured to release 1 billion tokens every Wednesday. This allows for faster testing of what would normally happen over years in production. The data below is read directly from the blockchain and updates in real-time.</p>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <a href="dev/release_token.html" class="btn btn-success mb-3">
              <i class="fas fa-rocket me-2"></i>Release Tokens
            </a>
            <p class="mb-2"><strong>Countdown to Next Release:</strong> <span id="releaseCountdown" class="text-primary">Calculating...</span></p>
            <p class="mb-0"><strong>Can Release Now:</strong> <span id="canRelease" class="text-primary">Loading...</span></p>
          </div>
        </div>

        <div class="card mb-4">
          <div class="card-body">
            <p class="mb-2 small"><strong>Testnet CA:</strong> <code><a href="https://testnet.bscscan.com/token/0x85a4850d0c2bdd6202c919c481bf0f186222fa89" target="_blank" class="text-decoration-none">0x85a4850d0c2bdd6202c919c481bf0f186222fa89</a></code></p>
            <p class="mb-2 small"><strong>Testnet VC:</strong> <code><a href="https://testnet.bscscan.com/address/0xC3C2b095C3aA55ACecc7fBA44C6B9D3f56dC43Da" target="_blank" class="text-decoration-none">0xC3C2b095C3aA55ACecc7fBA44C6B9D3f56dC43Da</a></code></p>
            <p class="mb-2 small"><strong>Testnet VC2:</strong> <code><a href="https://testnet.bscscan.com/address/0x2005408916003b37555D5A9B539867b387534e34" target="_blank" class="text-decoration-none">0x2005408916003b37555D5A9B539867b387534e34</a></code></p>
            <p class="mb-2 small"><strong>Network:</strong> BSC Testnet</p>
            <p class="mb-2 small"><strong>Last Release Time:</strong> <span id="lastRelease" class="text-primary">Loading...</span></p>
            <p class="mb-2 small"><strong>Is Today Wednesday:</strong> <span id="isWednesday" class="text-primary">Loading...</span></p>
            <p class="mb-2 small"><strong>Next Scheduled Release:</strong> <span id="nextReleaseDate" class="text-primary">Loading...</span></p>
            <p class="mb-0 small"><strong>Receipts for Releases:</strong> <code><a href="https://testnet.bscscan.com/token/0x85a4850d0c2bdd6202c919c481bf0f186222fa89?a=0xC3C2b095C3aA55ACecc7fBA44C6B9D3f56dC43Da" target="_blank" class="text-decoration-none">0xC3C2b095C3aA55ACecc7fBA44C6B9D3f56dC43Da</a></code></p>
          </div>
        </div>

        <section class="card mb-4">
          <div class="card-body">
            <h2 class="h5 text-success mb-3"><i class="fas fa-wallet me-2"></i>Wallet Balances</h2>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-success">
                  <tr>
                    <th>Name</th>
                    <th>Balance (GERD)</th>
                    <th>Wallet Address</th>
                  </tr>
                </thead>
                <tbody id="walletTable">
                  <tr><td colspan="3" class="text-center">Loading balances...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <div class="card">
          <div class="card-body">
            <h2 class="h5 mb-3">Release History</h2>
            <ul class="list-unstyled mb-0" id="releaseHistory">
              <li>Loading...</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const contractAddress = "0xC3C2b095C3aA55ACecc7fBA44C6B9D3f56dC43Da";
    const contractABI = [
      {
        inputs: [],
        name: "lastReleaseTime",
        outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
        stateMutability: "view",
        type: "function"
      }
    ];

    const web3 = new Web3("https://data-seed-prebsc-1-s1.binance.org:8545/");
    const contract = new web3.eth.Contract(contractABI, contractAddress);

    function getNextWednesdayTimestamp(fromTimestamp) {
      const SECONDS_IN_DAY = 86400;
      const day = Math.floor(fromTimestamp / SECONDS_IN_DAY + 4) % 7;
      const daysUntilNextWednesday = (7 + 3 - day) % 7 || 7;
      return (Math.floor(fromTimestamp / SECONDS_IN_DAY) + daysUntilNextWednesday) * SECONDS_IN_DAY;
    }

    async function loadDashboard() {
      try {
        const lastRelease = await contract.methods.lastReleaseTime().call();
        const isNeverReleased = lastRelease === "0";
        const now = Math.floor(Date.now() / 1000);

        document.getElementById("lastRelease").textContent = isNeverReleased
          ? "No token release has occurred yet"
          : new Date(lastRelease * 1000).toUTCString();

        const jsDay = new Date().getUTCDay();
        const isWed = jsDay === 3;
        document.getElementById("isWednesday").innerHTML = isWed ? '<i class="fas fa-check-circle text-success"></i> Yes' : '<i class="fas fa-times-circle text-danger"></i> No';

        const nextReleaseTime = isNeverReleased
          ? getNextWednesdayTimestamp(now)
          : parseInt(lastRelease) + 7 * 86400;
        document.getElementById("nextReleaseDate").textContent = new Date(nextReleaseTime * 1000).toUTCString();

        // Countdown
        const secondsLeft = nextReleaseTime - now;
        const days = Math.floor(secondsLeft / 86400);
        const hours = Math.floor((secondsLeft % 86400) / 3600);
        const minutes = Math.floor((secondsLeft % 3600) / 60);
        document.getElementById("releaseCountdown").textContent = secondsLeft > 0 
          ? `${days}d ${hours}h ${minutes}m` 
          : "Ready to release";

        // Can Release
        const releaseReady = now >= nextReleaseTime && isWed;
        document.getElementById("canRelease").innerHTML = releaseReady 
          ? '<i class="fas fa-check-circle text-success"></i> Yes' 
          : '<i class="fas fa-times-circle text-danger"></i> No';

        // Release History
        const historyList = document.getElementById("releaseHistory");
        if (isNeverReleased) {
          historyList.innerHTML = '<li>No releases yet</li>';
        } else {
          historyList.innerHTML = `<li><i class="fas fa-clock me-2"></i>Last release: ${new Date(lastRelease * 1000).toUTCString()}</li>`;
        }
      } catch (err) {
        console.error("Error loading dashboard:", err);
      }
    }

    const GERDTokenAddress = "0x85a4850d0c2bdd6202c919c481bf0f186222fa89";
    const tokenABI = [
      {
        constant: true,
        inputs: [{ name: "account", type: "address" }],
        name: "balanceOf",
        outputs: [{ name: "", type: "uint256" }],
        type: "function"
      },
      {
        constant: true,
        inputs: [],
        name: "decimals",
        outputs: [{ name: "", type: "uint8" }],
        type: "function"
      }
    ];

    const addresses = [
      { name: "Airdrop Wallet", addr: "0x87CC9e804B4A840297b18536D5d0E7A4835B0e3c" },
      { name: "Staking Wallet", addr: "0x3B84a366a2f25BbB48f34b2b8D587c02237E6a13" },
      { name: "Liquidity Wallet", addr: "0xdA96DBeDD6eF3f4f2b503565A7c6a5a65fbabf17" },
      { name: "Vesting Contract", addr: "0xC3C2b095C3aA55ACecc7fBA44C6B9D3f56dC43Da" },
      { name: "GERD Test Wallet", addr: "0xd84DB57e0d89cF6487b426e6BBbAb235b1139445" }
    ];

    const token = new web3.eth.Contract(tokenABI, GERDTokenAddress);

    async function loadBalances() {
      try {
        const decimals = await token.methods.decimals().call();
        let rows = "";
        for (const entry of addresses) {
          const balance = await token.methods.balanceOf(entry.addr).call();
          const formatted = (balance / 10 ** decimals).toLocaleString("en-US");
          rows += `<tr>
            <td>${entry.name}</td>
            <td>${formatted}</td>
            <td class="font-monospace small"><a href="https://testnet.bscscan.com/address/${entry.addr}" target="_blank" class="text-decoration-none">${entry.addr}</a></td>
          </tr>`;
        }
        document.getElementById("walletTable").innerHTML = rows;
      } catch (err) {
        console.error("Error loading balances:", err);
        document.getElementById("walletTable").innerHTML = '<tr><td colspan="3" class="text-danger text-center">Failed to load balances</td></tr>';
      }
    }

    loadDashboard();
    loadBalances();
    setInterval(loadDashboard, 60000); // Update every minute
  </script>

  <!-- Bootstrap 5.3.3 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
