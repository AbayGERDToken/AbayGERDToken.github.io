<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Abay GERD Token Claim</title>

  <!-- Bulma CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">

  <!-- Tailwind CSS + Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            green: {
              600: '#047857',
              100: '#d1fae5',
              200: '#a7f3d0'
            }
          }
        }
      }
    }
  </script>
  <script src="https://unpkg.com/flowbite@2.2.1/dist/flowbite.min.js"></script>

  <!-- Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.2/dist/web3.min.js"></script>

  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    input, button { width: 200px; padding: 10px; margin: 10px 0; }
    .success { color: green; }
    .error { color: red; }
    .loading { color: blue; }
    .g-recaptcha { margin: 10px 0; }
    .container { max-width: 400px; margin: auto; padding: 2em; }
    input#recipient, input#bwallet-address { width: 400px; }
    .copy-icon { transition: opacity 0.3s ease; }
  </style>
</head>
<body>

<!-- Injected Navbar -->
<div id="navbar-container"></div>
<script>
  fetch('navtest.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('navbar-container').innerHTML = html;
      setTimeout(() => {
        if (window.initFlowbite) initFlowbite();
      }, 200);
    });
</script>

<!-- Page Content -->
<div class="container">
  <a href="#" onclick="openChangeModal()">📢 See Claim Update</a>

  <!-- Modal -->
  <div id="changeModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; overflow:auto;">
    <div style="background:white; max-width:600px; width:90%; margin:50px auto; padding:20px; border-radius:12px;">
      <span style="position:absolute; top:10px; right:15px; font-size:24px; font-weight:bold; cursor:pointer;" onclick="closeChangeModal()">&times;</span>
      <h3 style="font-size:20px;">🎉 GERD Token Claim Update – Starting 05/05/2025</h3>
      <p>We’ve increased the total amount of GERD Tokens available for claiming:</p>
      <ul>
        <li>🌍 Global Claim: <strong>10,000 GERD</strong></li>
        <li>🇪🇹 Ethiopia-Based Claim: <strong>75,000 GERD</strong></li>
      </ul>
      <p>✅ Previous claimants will receive a 10x airdrop bonus!</p>
    </div>
  </div>

  <h2 class="title">Claim Your GERD Tokens 🎁🔑</h2>
  <p>
    ✅ <strong>No wallet connection required.</strong><br>
    Just submit your wallet address — no signing or private key needed.
  </p>
  <ul class="content">
    <li>📲 Import the GERD Token contract into your wallet</li>
    <li>🪪 Supported wallets: <a href="trust-wallet.html">Trust</a>, <a href="metamask-wallet.html">MetaMask</a>, Exodus, Halo Wallet</li>
    <li>🌐 Token contract: 
      <span id="contractAddress">0x660941bb4AA9FcBED00375673D21088A9d0C5019</span>
      <button onclick="copyToClipboard()" class="relative group">
        <svg id="copyIcon" class="h-5 w-5 text-gray-500 hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2"/>
        </svg>
        <svg id="checkIcon" class="h-5 w-5 text-green-600 absolute top-0 left-0 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
      </button>
    </li>
  </ul>

  <h3 class="subtitle">📌 Claim Eligibility</h3>
  <ul class="content">
    <li>🇪🇹 Ethiopia-based: <strong>75,000 GERD</strong></li>
    <li>🌍 Global wallets: <strong>10,000 GERD</strong></li>
  </ul>

  <h2>Wallet Address:</h2>
  <input class="input is-success" type="text" id="recipient" placeholder="GERD Wallet Address" />
  <div class="g-recaptcha" data-sitekey="6LdQyRkrAAAAANv5siZlVghMFzQ2AEPIg8501G9P"></div>
  <button class="button is-success" onclick="claimTokens()">Claim Tokens</button>
  <p id="response"></p>
</div>

<!-- Check Balance -->
<div class="container">
  <h3 class="subtitle">Check Your Balance</h3>
  <label for="bwallet-address">Wallet Address:</label>
  <input class="input is-success" type="text" placeholder="GERD wallet address" id="bwallet-address" />
  <button class="button is-success" type="button" id="check-balance">Check Balance</button>
  <strong><div id="balance-result">Balance: N/A</div></strong>
</div>

<!-- Footer -->
<footer class="footer">
  <div class="content has-text-centered">
    <p><a href="mailto:contact@abaygerdtoken.com"><strong>Contact us</strong></a> for support.<br>© 2023 Abay GERD Token</p>
  </div>
</footer>

<!-- JS Functions -->
<script>
function openChangeModal() {
  document.getElementById('changeModal').style.display = 'flex';
}
function closeChangeModal() {
  document.getElementById('changeModal').style.display = 'none';
}
function copyToClipboard() {
  const el = document.getElementById("contractAddress");
  const range = document.createRange();
  range.selectNode(el);
  window.getSelection().removeAllRanges();
  window.getSelection().addRange(range);
  document.execCommand("copy");
  window.getSelection().removeAllRanges();
  document.getElementById("copyIcon").style.display = 'none';
  document.getElementById("checkIcon").style.display = 'block';
  setTimeout(() => {
    document.getElementById("checkIcon").style.display = 'none';
    document.getElementById("copyIcon").style.display = 'block';
  }, 1500);
}
</script>

<!-- Balance checker -->
<script>
const web3a = new Web3("https://bsc-dataseed.binance.org/");
const contractABI = [/* contract ABI truncated here for brevity */];
const contractAddress = "0x660941bb4AA9FcBED00375673D21088A9d0C5019";
const gerdContract = new web3a.eth.Contract(contractABI, contractAddress);
document.getElementById("check-balance").addEventListener("click", async () => {
  const addr = document.getElementById("bwallet-address").value;
  if (!web3a.utils.isAddress(addr)) {
    document.getElementById("balance-result").innerText = `Error: Invalid address`;
    return;
  }
  const balance = await gerdContract.methods.balanceOf(addr).call();
  const formatted = (balance / 10 ** 2).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  document.getElementById("balance-result").innerText = `Your balance is: ${formatted} GERD`;
});
</script>

<!-- Claim tokens (backend call) -->
<script>
let sessionToken = "";
async function fetchSessionToken() {
  try {
    const res = await fetch('https://abay-gerd-backend.onrender.com/auth/session');
    const data = await res.json();
    sessionToken = data.session_token;
    return sessionToken;
  } catch (err) {
    console.error("Session error:", err);
    return null;
  }
}
async function claimTokens() {
  const recipient = document.getElementById('recipient').value.trim();
  const responseEl = document.getElementById('response');
  const recaptchaToken = grecaptcha.getResponse();
  if (!web3a.utils.isAddress(recipient)) {
    responseEl.textContent = "Invalid address.";
    responseEl.className = "error";
    return;
  }
  if (!recaptchaToken) {
    responseEl.textContent = "Please complete reCAPTCHA.";
    responseEl.className = "error";
    return;
  }
  if (!sessionToken) {
    await fetchSessionToken();
    if (!sessionToken) {
      responseEl.textContent = "Session error. Please try again.";
      responseEl.className = "error";
      return;
    }
  }
  responseEl.textContent = "⏳ Processing...";
  responseEl.className = "loading";
  try {
    const locData = await (await fetch("https://ipapi.co/json/")).json();
    const amount = (locData.country_code === "ET") ? 75000 : 10000;
    const res = await fetch("https://abay-gerd-backend.onrender.com/send-token", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ recipient, recaptchaToken, session_token: sessionToken })
    });
    const data = await res.json();
    if (data.status === "success") {
      responseEl.innerHTML = `✅ Success! Tx Hash: <a href="https://bscscan.com/tx/0x${data.tx_hash}" target="_blank">0x${data.tx_hash}</a>`;
      responseEl.className = "success";
    } else {
      responseEl.textContent = `❌ ${data.message}`;
      responseEl.className = "error";
    }
  } catch (err) {
    responseEl.textContent = `❌ Error: ${err.message}`;
    responseEl.className = "error";
  } finally {
    grecaptcha.reset();
  }
}
</script>

</body>
</html>
